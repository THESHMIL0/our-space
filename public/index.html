<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <title>Our Space OS</title>
    <style>
        :root { --primary: #ff4757; --ios-blue: #007aff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); overflow: hidden; color: #333; height: 100vh; height: 100dvh; display: flex; flex-direction: column; padding-bottom: env(safe-area-inset-bottom); }
        
        #dynamic-island { position: fixed; top: max(12px, env(safe-area-inset-top)); left: 50%; transform: translateX(-50%); width: 130px; height: 35px; background: black; border-radius: 30px; z-index: 100000; transition: 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: 600; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); pointer-events: none; }
        .island-active { width: 90%; height: 65px; justify-content: flex-start; padding: 0 20px; box-sizing: border-box; }
        #island-text { opacity: 0; transition: 0.3s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        .island-active #island-text { opacity: 1; transition-delay: 0.2s; }

        #status-bar { display: flex; justify-content: space-between; padding: 15px 30px; font-weight: 600; color: rgba(0,0,0,0.6); font-size: 13px; padding-top: calc(15px + env(safe-area-inset-top)); }
        
        .locket-widget { grid-column: span 4; height: 160px; background: rgba(255,255,255,0.3); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.4); border-radius: 35px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.08); margin-bottom: 5px; cursor: pointer; flex-direction: column; color: rgba(0,0,0,0.5); font-weight: bold; font-size: 14px; }
        .locket-widget img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; display: none; z-index: 2; transition: opacity 0.3s; }
        .locket-widget:active { transform: scale(0.97); }

        #home-screen { flex: 1; padding: 10px 25px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px 15px; align-content: start; }
        .home-app { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .home-icon { width: 60px; height: 60px; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 32px; box-shadow: 0 6px 20px rgba(0,0,0,0.12); margin-bottom: 6px; transition: 0.2s; position: relative; overflow: hidden; }
        .home-icon:active { transform: scale(0.9); filter: brightness(0.8); }
        .app-label { font-size: 11px; font-weight: 600; color: #444; text-align: center; letter-spacing: 0.3px; text-shadow: 0 1px 5px rgba(255,255,255,0.6); }

        #dock { background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); margin: 10px 20px 30px 20px; border-radius: 40px; padding: 15px; display: flex; justify-content: space-around; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.5); }
        .dock-icon { width: 60px; height: 60px; background: white; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 32px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.08); transition: 0.2s; }
        .dock-icon:active { transform: scale(0.9); }
        
        .app-window { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f2f2f7; display: none; flex-direction: column; z-index: 100; animation: slideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes slideUp { from { transform: translateY(100%); border-radius: 40px; } to { transform: translateY(0); border-radius: 0; } }
        
        .app-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.7); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border-bottom: 1px solid rgba(0,0,0,0.1); font-weight: 600; font-size: 17px; padding-top: calc(15px + env(safe-area-inset-top)); z-index: 10; position: relative; }
        .app-title { position: absolute; left: 50%; transform: translateX(-50%); font-weight: 600; color: #000; }
        .done-btn { color: var(--ios-blue); cursor: pointer; font-size: 17px; font-weight: 500; z-index: 2; }
        
        .chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .bubble { max-width: 75%; padding: 12px 18px; border-radius: 22px; font-size: 16px; line-height: 1.4; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .me { align-self: flex-end; background: var(--ios-blue); color: white; border-bottom-right-radius: 6px; }
        .them { align-self: flex-start; background: #e9e9eb; color: black; border-bottom-left-radius: 6px; }
        .input-area { padding: 15px; border-top: 1px solid #ccc; display: flex; gap: 10px; background: #f8f9fa; padding-bottom: calc(30px + env(safe-area-inset-bottom)); }
        .chat-input { flex: 1; padding: 12px 20px; border-radius: 25px; border: 1px solid #ddd; outline: none; background: #fff; font-size: 16px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.02); }
        
        .full-note-input { flex: 1; width: 100%; border: none; outline: none; resize: none; font-family: inherit; font-size: 18px; padding: 25px; background: #fffcf2; color: #333; line-height: 1.6; box-sizing: border-box; }
        #list-container { flex: 1; padding: 20px; overflow-y: auto; background: white; }
        .list-item { background: #f8f9fa; padding: 18px 20px; border-radius: 18px; margin-bottom: 12px; font-weight: 500; font-size: 16px; display: flex; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .list-item::before { content: '‚ú®'; margin-right: 12px; font-size: 20px; }

        #snap-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 999999; display: none; flex-direction: column; }
        #snap-image { flex: 1; width: 100%; object-fit: contain; }
        #snap-timer-bar { height: 6px; background: var(--primary); width: 100%; border-radius: 0 0 10px 10px; }

        /* TIC-TAC-TOE UPGRADES */
        #ttt-status { font-size: 22px; font-weight: 800; color: #333; margin: 15px 0 5px 0; transition: 0.3s; }
        #ttt-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; width: 280px; margin: 15px auto 30px auto; }
        .cell { width: 85px; height: 85px; background: white; border-radius: 22px; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: 0.2s;}
        .cell:active { transform: scale(0.95); }
        
        /* The magical glowing effect when someone wins! */
        .winning-cell { background: #ffeaa7 !important; transform: scale(1.05); box-shadow: 0 0 20px rgba(253, 203, 110, 0.8) !important; z-index: 10; }

        .game-btn { display:block; margin: 15px auto; padding: 15px 30px; border-radius: 30px; border: none; background: #2f3542; color: white; font-weight: bold; font-size: 16px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        #draw-board { border-radius: 20px; background: white; touch-action: none; margin: 10px auto; display: block; box-shadow: 0 5px 20px rgba(0,0,0,0.06); }
        .draw-tools { display: flex; justify-content: center; align-items: center; gap: 12px; margin-bottom: 15px; }
        .color-btn { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 3px solid transparent; transition: 0.2s; }
        .color-btn:active { transform: scale(0.9); }
        .eraser-btn { padding: 8px 15px; border-radius: 20px; background: white; border: 1px solid #ccc; font-weight: bold; font-size: 14px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .floating-heart { position: fixed; bottom: -50px; font-size: 50px; animation: floatUp 3s ease-in forwards; z-index: 1000; pointer-events: none; text-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1) rotate(0deg); opacity: 1; } 100% { transform: translateY(-100vh) scale(1.5) rotate(20deg); opacity: 0; } }
    </style>
</head>
<body>
    <div id="dynamic-island"><span id="island-text">Notification</span></div>

    <div id="status-bar">
        <span id="clock">12:00</span>
        <span style="display:flex; gap: 8px; align-items:center;">
            <span>5G</span>
            <div style="width: 22px; height: 11px; border: 1px solid rgba(0,0,0,0.5); border-radius: 3px; position: relative;">
                <div style="background: rgba(0,0,0,0.7); width: 80%; height: 100%; border-radius: 1px;"></div>
                <div style="position:absolute; right:-3px; top:3px; width:2px; height:4px; background:rgba(0,0,0,0.5); border-radius:1px;"></div>
            </div>
        </span>
    </div>

    <div style="text-align:center; padding: 5px 0 15px 0; font-weight:600; color:white; font-size: 14px; text-shadow:0 1px 5px rgba(0,0,0,0.3); opacity: 0.9;">
        Partner's Mood: <span id="partner-mood-display">üòä</span>
    </div>

    <div id="home-screen">
        <div class="locket-widget" onclick="document.getElementById('locket-input').click()">
            <span style="font-size: 35px; margin-bottom: 5px;">üñºÔ∏è</span>Tap to update Locket
            <img id="locket-display" src="" />
            <input type="file" id="locket-input" accept="image/*" style="display:none;" onchange="sendLocket(event)">
        </div>

        <div class="home-app" onclick="openApp('notesApp')"><div class="home-icon" style="background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);">üìù</div><div class="app-label">Notes</div></div>
        <div class="home-app" onclick="openApp('listApp')"><div class="home-icon" style="background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); color: white;">‚úÖ</div><div class="app-label">Bucket List</div></div>
        <div class="home-app" onclick="document.getElementById('camera-input').click()"><div class="home-icon" style="background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); color: white;">üì∏</div><div class="app-label">Camera</div><input type="file" id="camera-input" accept="image/*" capture="environment" style="display:none;" onchange="sendSnap(event)"></div>
        <div class="home-app" onclick="openApp('moodApp')"><div class="home-icon" style="background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);">üé≠</div><div class="app-label">Mood</div></div>
        <div class="home-app" onclick="openGameApp('ttt', 'Tic-Tac-Toe')"><div class="home-icon" style="background: linear-gradient(135deg, #74ebd5 0%, #9face6 100%); color: white;">‚ùå‚≠ï</div><div class="app-label">Tic-Tac</div></div>
        <div class="home-app" onclick="openGameApp('draw', 'Drawing Canvas')"><div class="home-icon" style="background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);">üé®</div><div class="app-label">Draw</div></div>
        <div class="home-app" onclick="openGameApp('tod', 'Truth or Dare')"><div class="home-icon" style="background: linear-gradient(135deg, #ff0844 0%, #ffb199 100%); color: white;">üé≤</div><div class="app-label">Dare</div></div>
        <div class="home-app" onclick="openGameApp('coin', 'Coin Flip')"><div class="home-icon" style="background: linear-gradient(135deg, #fccb90 0%, #d57eeb 100%);">ü™ô</div><div class="app-label">Coin</div></div>
    </div>

    <div id="dock">
        <div class="dock-icon" onclick="openApp('messageApp')">üí¨</div>
        <div class="dock-icon" onclick="triggerHeart()" style="background: var(--primary); color: white;">‚ù§Ô∏è</div>
    </div>

    <div id="moodApp" class="app-window">
        <div class="app-header"><div style="width:40px;"></div><span class="app-title">Set Mood</span><span class="done-btn" onclick="closeApp('moodApp')">Done</span></div>
        <div style="padding: 30px 20px; text-align: center;"><h3 style="color:#333; margin-bottom: 25px;">How are you feeling?</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <button class="game-btn" onclick="setMood('Happy üòä')" style="margin:0; width:100%; background:#7bed9f; color:black;">Happy üòä</button>
                <button class="game-btn" onclick="setMood('Miss You ü•∫')" style="margin:0; width:100%; background:#ff7f50; color:white;">Miss You ü•∫</button>
                <button class="game-btn" onclick="setMood('Sleepy üò¥')" style="margin:0; width:100%; background:#a4b0be; color:white;">Sleepy üò¥</button>
                <button class="game-btn" onclick="setMood('Busy üíª')" style="margin:0; width:100%; background:#ff4757; color:white;">Busy üíª</button>
            </div>
        </div>
    </div>

    <div id="snap-overlay"><div id="snap-timer-bar"></div><img id="snap-image" src="" /><p style="color: white; text-align: center; font-weight: bold; margin-bottom: 30px;">Secret Snap (Disappearing in 10s)</p></div>

    <div id="listApp" class="app-window"><div class="app-header"><div style="width:40px;"></div><span class="app-title">Bucket List</span><span class="done-btn" onclick="closeApp('listApp')">Done</span></div><div id="list-container"></div><div class="input-area"><input id="list-input" class="chat-input" placeholder="Add a dream..." autocomplete="off" /><button onclick="addListItem()" style="background:#a18cd1; color:white; border:none; border-radius:50%; width:40px; height:40px; font-size:20px;">+</button></div><button class="game-btn" style="background: #ff4757; width: 90%; margin-bottom: 30px;" onclick="clearList()">Clear Finished List</button></div>
    <div id="notesApp" class="app-window"><div class="app-header"><div style="width:40px;"></div><span class="app-title">Shared Notes</span><span class="done-btn" onclick="closeApp('notesApp')">Done</span></div><textarea id="app-note" class="full-note-input" oninput="sendNote()" placeholder="Type something sweet here..."></textarea></div>
    <div id="messageApp" class="app-window"><div class="app-header"><div style="width:40px;"></div><span class="app-title">Messages</span><span class="done-btn" onclick="closeApp('messageApp')">Done</span></div><div id="main-chat" class="chat-container"></div><div class="input-area"><input id="main-input" class="chat-input" placeholder="iMessage" autocomplete="off" /><button onclick="sendMessage('main-input')" style="background:var(--ios-blue); color:white; border:none; border-radius:50%; width:40px; height:40px; font-weight:bold;">‚Üë</button></div></div>
    
    <div id="gamesApp" class="app-window">
        <div class="app-header"><div style="width:40px;"></div><span id="game-title" class="app-title">App</span><span class="done-btn" onclick="closeApp('gamesApp')">Done</span></div>
        <div id="game-screens" style="text-align: center; border-bottom: 1px solid #ddd; padding-bottom: 20px; background: white;">
            
            <div id="screen-ttt">
                <h3 id="ttt-status">X's Turn</h3>
                <div id="ttt-grid">
                    <div class="cell" onclick="makeMove(0)"></div><div class="cell" onclick="makeMove(1)"></div><div class="cell" onclick="makeMove(2)"></div>
                    <div class="cell" onclick="makeMove(3)"></div><div class="cell" onclick="makeMove(4)"></div><div class="cell" onclick="makeMove(5)"></div>
                    <div class="cell" onclick="makeMove(6)"></div><div class="cell" onclick="makeMove(7)"></div><div class="cell" onclick="makeMove(8)"></div>
                </div>
                <button class="game-btn" onclick="resetGame()">Restart Game</button>
            </div>
            
            <div id="screen-draw" style="display:none; padding-top: 15px;">
                <div class="draw-tools">
                    <input type="color" id="color-picker" value="#ff4757" style="width: 35px; height: 35px; border: none; border-radius: 50%; cursor: pointer;" onchange="setBrush(this.value)">
                    <div class="color-btn" style="background:#2ed573;" onclick="setBrush('#2ed573')"></div>
                    <div class="color-btn" style="background:#1e90ff;" onclick="setBrush('#1e90ff')"></div>
                    <div class="color-btn" style="background:#2f3542;" onclick="setBrush('#2f3542')"></div>
                    <button class="eraser-btn" onclick="setBrush('#ffffff')">Eraser</button>
                </div>
                <div class="draw-tools" style="margin-bottom: 15px;"><span style="font-size: 14px; font-weight: bold; color: #555;">Thickness:</span><input type="range" id="brush-size" style="width: 120px;" min="2" max="20" value="4" onchange="updateSize(this.value)"></div>
                <canvas id="draw-board" width="280" height="280"></canvas>
                <button class="game-btn" style="background: #ff9f43;" onclick="clearCanvas()">Erase Canvas</button>
            </div>

            <div id="screen-tod" style="display:none; padding: 30px;"><h3>Truth or Dare</h3><button class="game-btn" style="background: #ff4757;" onclick="playToD()">Spin the Wheel üé≤</button></div>
            <div id="screen-coin" style="display:none; padding: 30px;"><h3>Coin Flip</h3><button class="game-btn" style="background: #eccc68; color: black;" onclick="flipCoin()">Flip a Coin ü™ô</button></div>
        </div>
        <div id="mini-chat" class="chat-container" style="background: #f2f2f7; padding: 10px; flex: 1;"></div>
        <div class="input-area" style="padding: 10px; background:white;"><input id="mini-input" class="chat-input" placeholder="Trash talk..." autocomplete="off" /><button onclick="sendMessage('mini-input')" style="background:#2ed573; color:white; border:none; border-radius:50%; width:40px; height:40px; font-weight:bold;">‚Üë</button></div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();
        
        setInterval(() => { const now = new Date(); let h = now.getHours(); let m = now.getMinutes(); document.getElementById('clock').innerText = (h % 12 || 12) + ':' + (m < 10 ? '0'+m : m); }, 1000);

        function openApp(id) { document.getElementById(id).style.display = 'flex'; }
        function closeApp(id) { document.getElementById(id).style.display = 'none'; }
        function openGameApp(gameId, title) {
            document.getElementById('game-title').innerText = title;
            ['ttt', 'draw', 'tod', 'coin'].forEach(id => document.getElementById('screen-' + id).style.display = 'none');
            document.getElementById('screen-' + gameId).style.display = 'block'; openApp('gamesApp');
        }

        socket.on('notification', (text) => {
            const island = document.getElementById('dynamic-island'); document.getElementById('island-text').innerText = text;
            island.classList.add('island-active'); if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
            setTimeout(() => { island.classList.remove('island-active'); }, 4000);
        });

        function sendLocket(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { socket.emit('update locket', e.target.result); }; reader.readAsDataURL(file); }
        socket.on('locket update', (imgData) => { const imgEl = document.getElementById('locket-display'); if(imgData) { imgEl.src = imgData; imgEl.style.display = 'block'; } });
        function setMood(mood) { socket.emit('set mood', mood); closeApp('moodApp'); }
        socket.on('mood update', mood => { document.getElementById('partner-mood-display').innerText = mood; });
        
        function sendSnap(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { socket.emit('send snap', e.target.result); }; reader.readAsDataURL(file); }
        socket.on('receive snap', (imgData) => {
            const overlay = document.getElementById('snap-overlay'); const img = document.getElementById('snap-image'); const timerBar = document.getElementById('snap-timer-bar');
            img.src = imgData; overlay.style.display = 'flex'; timerBar.style.transition = 'none'; timerBar.style.width = '100%';
            setTimeout(() => { timerBar.style.transition = 'width 10s linear'; timerBar.style.width = '0%'; }, 50);
            setTimeout(() => { overlay.style.display = 'none'; img.src = ""; }, 10000);
        });

        function addListItem() { var input = document.getElementById('list-input'); if(input.value) { socket.emit('add item', input.value); input.value = ''; } }
        function clearList() { socket.emit('clear list'); }
        socket.on('list update', list => { const container = document.getElementById('list-container'); container.innerHTML = ''; list.forEach(item => { let div = document.createElement('div'); div.className = 'list-item'; div.innerText = item; container.appendChild(div); }); });

        const noteBox = document.getElementById('app-note'); function sendNote() { socket.emit('update note', noteBox.value); }
        socket.on('note update', text => { if(document.activeElement !== noteBox) noteBox.value = text; });

        function addMessageToBoth(text, type) { const createBubble = () => { var div = document.createElement('div'); div.className = 'bubble ' + type; div.textContent = text; return div; }; let mainChat = document.getElementById('main-chat'); mainChat.appendChild(createBubble()); mainChat.scrollTop = mainChat.scrollHeight; let miniChat = document.getElementById('mini-chat'); miniChat.appendChild(createBubble()); miniChat.scrollTop = miniChat.scrollHeight; }
        function sendMessage(inputId) { var inputField = document.getElementById(inputId); if(inputField.value) { addMessageToBoth(inputField.value, 'me'); socket.emit('chat message', {text: inputField.value}); inputField.value = ''; } }
        socket.on('chat message', d => addMessageToBoth(d.text, 'them'));

        function triggerHeart() { socket.emit('send heart'); }
        socket.on('show heart', () => { const heart = document.createElement('div'); heart.innerText = '‚ù§Ô∏è'; heart.className = 'floating-heart'; heart.style.left = Math.random() * 80 + 10 + 'vw'; document.body.appendChild(heart); setTimeout(() => heart.remove(), 3000); });

        // --- üèÜ THE NEW TIC-TAC-TOE ENGINE ---
        let currentTurn = 'X'; 
        let localGameState = Array(9).fill(null);
        let gameActive = true;

        function makeMove(idx) { 
            // Anti-Cheat: Stop if cell is full or game is already over
            if (localGameState[idx] || !gameActive) return; 
            socket.emit('make move', { index: idx, symbol: currentTurn }); 
        }

        socket.on('game update', state => { 
            localGameState = state;
            const cells = document.querySelectorAll('#ttt-grid .cell'); 
            let xCount = 0; let oCount = 0; 
            
            cells.forEach(c => c.classList.remove('winning-cell')); // Reset glow
            
            state.forEach((val, i) => { 
                cells[i].innerText = val || ''; 
                if (val === 'X') xCount++; 
                if (val === 'O') oCount++; 
                cells[i].style.color = val === 'X' ? '#ff4757' : '#2ed573'; 
            }); 
            
            currentTurn = (xCount > oCount) ? 'O' : 'X'; 
            document.getElementById('ttt-status').innerText = `${currentTurn}'s Turn`;
            
            checkWinAndDraw(state);
        });

        function checkWinAndDraw(state) {
            const winConditions = [ [0,1,2], [3,4,5], [6,7,8], [0,3,6], [1,4,7], [2,5,8], [0,4,8], [2,4,6] ];
            let roundWon = false;
            for (let i = 0; i < winConditions.length; i++) {
                const winCondition = winConditions[i];
                let a = state[winCondition[0]], b = state[winCondition[1]], c = state[winCondition[2]];
                if (a === null || b === null || c === null) continue;
                if (a === b && b === c) {
                    roundWon = true;
                    // Make the winning tiles glow!
                    document.querySelectorAll('#ttt-grid .cell')[winCondition[0]].classList.add('winning-cell');
                    document.querySelectorAll('#ttt-grid .cell')[winCondition[1]].classList.add('winning-cell');
                    document.querySelectorAll('#ttt-grid .cell')[winCondition[2]].classList.add('winning-cell');
                    document.getElementById('ttt-status').innerText = `üéâ ${a} Wins! üéâ`;
                    document.getElementById('ttt-status').style.color = a === 'X' ? '#ff4757' : '#2ed573';
                    gameActive = false;
                    break;
                }
            }
            if (!roundWon && !state.includes(null)) {
                document.getElementById('ttt-status').innerText = `It's a Draw! ü§ù`;
                document.getElementById('ttt-status').style.color = '#333';
                gameActive = false;
            } else if (!roundWon) {
                gameActive = true;
                document.getElementById('ttt-status').style.color = '#333';
            }
        }

        function resetGame() { socket.emit('reset game'); }

        const prompts = ["Truth: First impression of me?", "Dare: Send a silly selfie!", "Truth: Favorite memory?", "Dare: Emoji only for 5 mins!", "Truth: A secret you haven't told me?", "Dare: I pick dinner tonight!"];
        function playToD() { let msg = "üé≤ " + prompts[Math.floor(Math.random() * prompts.length)]; addMessageToBoth(msg, 'me'); socket.emit('chat message', {text: msg}); }
        function flipCoin() { let msg = "ü™ô Flipped a coin: **" + (Math.random() < 0.5 ? "Heads" : "Tails") + "**!"; addMessageToBoth(msg, 'me'); socket.emit('chat message', {text: msg}); }

        const canvas = document.getElementById('draw-board'); const ctx = canvas.getContext('2d');
        ctx.lineCap = 'round'; ctx.lineJoin = 'round'; let drawing = false; let brushColor = '#ff4757'; let brushSize = 4;
        function setBrush(color) { brushColor = color; } function updateSize(size) { brushSize = size; }
        function getPos(e) { const rect = canvas.getBoundingClientRect(); return { x: (e.touches ? e.touches[0].clientX : e.clientX) - rect.left, y: (e.touches ? e.touches[0].clientY : e.clientY) - rect.top }; }
        function startDraw(e) { drawing = true; const pos = getPos(e); socket.emit('draw', { type: 'start', x: pos.x, y: pos.y, color: brushColor, size: brushSize }); ctx.beginPath(); ctx.strokeStyle = brushColor; ctx.lineWidth = brushSize; ctx.moveTo(pos.x, pos.y); e.preventDefault(); }
        function drawLine(e) { if (!drawing) return; const pos = getPos(e); socket.emit('draw', { type: 'draw', x: pos.x, y: pos.y, color: brushColor, size: brushSize }); ctx.strokeStyle = brushColor; ctx.lineWidth = brushSize; ctx.lineTo(pos.x, pos.y); ctx.stroke(); e.preventDefault(); }
        function stopDraw() { drawing = false; ctx.beginPath(); }
        canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', drawLine); canvas.addEventListener('mouseup', stopDraw);
        canvas.addEventListener('touchstart', startDraw, {passive: false}); canvas.addEventListener('touchmove', drawLine, {passive: false}); canvas.addEventListener('touchend', stopDraw);
        socket.on('draw', data => { if (data.type === 'start') { ctx.beginPath(); ctx.strokeStyle = data.color || '#ff4757'; ctx.lineWidth = data.size || 4; ctx.moveTo(data.x, data.y); } else if (data.type === 'draw') { ctx.strokeStyle = data.color || '#ff4757'; ctx.lineWidth = data.size || 4; ctx.lineTo(data.x, data.y); ctx.stroke(); } else if (data.type === 'clear') { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.beginPath(); } });
        function clearCanvas() { socket.emit('draw', { type: 'clear' }); ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.beginPath(); }
    </script>
</body>
</html>
