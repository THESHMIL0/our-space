<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="/manifest.json">
    <title>Arcade OS</title>
    <style>
        :root { --primary: #ff4757; --ios-blue: #007aff; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); background-size: cover; overflow: hidden; height: 100vh; display: flex; flex-direction: column; padding-bottom: env(safe-area-inset-bottom); }
        
        #status-bar { display: flex; justify-content: space-between; padding: 15px 30px; font-weight: 600; color: white; font-size: 14px; padding-top: calc(15px + env(safe-area-inset-top)); text-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        
        #home-screen { flex: 1; padding: 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px 15px; align-content: start; }
        .home-app { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .home-icon { width: 70px; height: 70px; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 40px; box-shadow: 0 8px 20px rgba(0,0,0,0.2); transition: 0.2s; }
        .home-icon:active { transform: scale(0.85); }
        .app-label { font-size: 12px; font-weight: 700; color: white; margin-top: 8px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

        #dock { background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(20px); margin: 0 20px 30px; border-radius: 35px; padding: 15px; display: flex; justify-content: space-around; border: 1px solid rgba(255,255,255,0.3); }
        .dock-icon { width: 60px; height: 60px; background: white; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 32px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        .app-window { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f2f2f7; display: none; flex-direction: column; z-index: 100; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .app-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: white; border-bottom: 1px solid #ddd; padding-top: calc(15px + env(safe-area-inset-top)); }
        
        .chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; background: #fafafa; }
        .bubble { max-width: 80%; padding: 10px 15px; border-radius: 18px; font-size: 15px; position: relative; }
        .me { align-self: flex-end; background: var(--ios-blue); color: white; }
        .them { align-self: flex-start; background: #e9e9eb; color: black; }

        .app-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; }
        
        /* Game Specifics */
        #c4-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; background: #007aff; padding: 10px; border-radius: 10px; }
        .c4-cell { width: 35px; height: 35px; background: white; border-radius: 50%; }
        #ttt-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .cell { width: 80px; height: 80px; background: #eee; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 40px; }
        
        .shake-screen { animation: shake 0.5s; }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-3px, -2px); } 100% { transform: translate(1px, 1px); } }
    </style>
</head>
<body>
    <div id="status-bar"><span id="clock">12:00</span><span id="batt">100% üîã</span></div>

    <div id="home-screen">
        <div class="home-app" onclick="openGame('ttt', 'Tic-Tac-Toe')"><div class="home-icon" style="background:linear-gradient(#ff7eb3, #ff758c)">‚ùå</div><div class="app-label">Tic-Tac</div></div>
        <div class="home-app" onclick="openGame('c4', 'Connect 4')"><div class="home-icon" style="background:linear-gradient(#4facfe, #00f2fe)">üîµ</div><div class="app-label">Connect 4</div></div>
        <div class="home-app" onclick="openGame('bal', 'Balloon')"><div class="home-icon" style="background:linear-gradient(#f093fb, #f5576c)">üéà</div><div class="app-label">Balloon</div></div>
        <div class="home-app" onclick="openGame('rps', 'RPS')"><div class="home-icon" style="background:linear-gradient(#84fab0, #8fd3f4)">‚úåÔ∏è</div><div class="app-label">RPS</div></div>
        <div class="home-app" onclick="openGame('draw', 'Draw')"><div class="home-icon" style="background:linear-gradient(#fa709a, #fee140)">üé®</div><div class="app-label">Draw</div></div>
        <div class="home-app" onclick="openGame('tap', 'Tap Battle')"><div class="home-icon" style="background:linear-gradient(#667eea, #764ba2)">‚öîÔ∏è</div><div class="app-label">Battle</div></div>
    </div>

    <div id="dock">
        <div class="dock-icon" onclick="openApp('mainChatApp')">üí¨</div>
        <div class="dock-icon" onclick="socket.emit('send buzz')" style="background:#f1c40f">üì≥</div>
        <div class="dock-icon" onclick="openApp('settingsApp')" style="background:#333">‚öôÔ∏è</div>
    </div>

    <div id="mainChatApp" class="app-window">
        <div class="app-header"><span>Messages</span><span class="done-btn" onclick="closeApp('mainChatApp')">Done</span></div>
        <div id="main-chat-box" class="chat-container"></div>
        <div class="input-area">
            <input id="main-chat-input" class="chat-input" placeholder="Say something..." />
            <button onclick="sendMsg('main')" style="background:var(--ios-blue); color:white; border:none; border-radius:50%; width:40px; height:40px;">‚Üë</button>
        </div>
    </div>

    <div id="settingsApp" class="app-window">
        <div class="app-header"><span>Settings</span><span class="done-btn" onclick="closeApp('settingsApp')">Done</span></div>
        <div class="app-content">
            <button class="game-btn" onclick="socket.emit('set wallpaper', 'linear-gradient(to right, #0f0c29, #302b63, #24243e)')">Dark Mode</button>
            <button class="game-btn" style="background:#ff9a9e" onclick="socket.emit('set wallpaper', 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)')">Pink Mode</button>
        </div>
    </div>

    <div id="gameApp" class="app-window">
        <div class="app-header"><span id="game-title">Game</span><span class="done-btn" onclick="closeApp('gameApp')">Exit</span></div>
        <div id="game-screens" class="app-content">
            <div id="screen-ttt" style="display:none"><div id="ttt-grid"></div></div>
            <div id="screen-c4" style="display:none"><div id="c4-grid"></div></div>
            <div id="screen-bal" style="display:none"><div id="balloon-emoji" style="font-size:50px">üéà</div><button class="game-btn" onclick="socket.emit('balloon pump')">PUMP</button></div>
            <div id="screen-rps" style="display:none"><button class="game-btn" onclick="socket.emit('rps pick', 'üëä')">üëä</button><button class="game-btn" onclick="socket.emit('rps pick', 'üìÑ')">üìÑ</button><button class="game-btn" onclick="socket.emit('rps pick', '‚úåÔ∏è')">‚úåÔ∏è</button></div>
            <div id="screen-draw" style="display:none"><canvas id="draw-board" width="300" height="300"></canvas></div>
            <div id="screen-tap" style="display:none"><div id="tap-bar" style="width:100%; background:#eee; height:20px;"><div id="tap-fill" style="width:50%; background:red; height:100%"></div></div><button class="game-btn" onclick="socket.emit('tap pull', 'red')">TAP!</button></div>
        </div>
        <div id="game-chat-box" class="chat-container" style="height:150px; flex:none; border-top:1px solid #ddd"></div>
        <div class="input-area">
            <input id="game-chat-input" class="chat-input" placeholder="Game talk..." />
            <button onclick="sendMsg('game')" style="background:#2ed573; color:white; border:none; border-radius:50%; width:40px; height:40px;">‚Üë</button>
        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        function openApp(id) { document.getElementById(id).style.display = 'flex'; }
        function closeApp(id) { document.getElementById(id).style.display = 'none'; }
        
        function openGame(id, title) {
            document.getElementById('game-title').innerText = title;
            document.querySelectorAll('#game-screens > div').forEach(d => d.style.display = 'none');
            document.getElementById('screen-' + id).style.display = 'block';
            openApp('gameApp');
        }

        // üí¨ SEPARATED SENDING
        function sendMsg(type) {
            const input = document.getElementById(type + '-chat-input');
            if(!input.value) return;
            addBubble(type, input.value, 'me');
            socket.emit(type + ' message', { text: input.value });
            input.value = '';
        }

        function addBubble(type, text, sender) {
            const box = document.getElementById(type + '-chat-box');
            const div = document.createElement('div');
            div.className = 'bubble ' + sender;
            div.innerText = text;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        socket.on('main message', d => addBubble('main', d.text, 'them'));
        socket.on('game message', d => addBubble('game', d.text, 'them'));

        // üéÆ GAME LOGIC SYNC
        socket.on('game update', state => {
            const grid = document.getElementById('ttt-grid'); grid.innerHTML = '';
            state.forEach((val, i) => {
                const c = document.createElement('div'); c.className = 'cell'; c.innerText = val || '';
                c.onclick = () => socket.emit('make move', {index: i, symbol: 'X'});
                grid.appendChild(c);
            });
        });

        socket.on('balloon update', d => {
            const b = document.getElementById('balloon-emoji');
            b.style.transform = `scale(${1 + d.pumps*0.1})`;
            if(d.popped) b.innerText = "üí•"; else b.innerText = "üéà";
        });

        socket.on('tap update', s => { document.getElementById('tap-fill').style.width = s + '%'; });
        socket.on('wallpaper update', bg => { document.body.style.background = bg; });
        socket.on('receive buzz', () => { document.body.classList.add('shake-screen'); setTimeout(()=>document.body.classList.remove('shake-screen'), 500); });

        // Tic Tac Toe Grid Gen
        const tttGrid = document.getElementById('ttt-grid');
        for(let i=0; i<9; i++){ const c = document.createElement('div'); c.className='cell'; tttGrid.appendChild(c); }

        // Connect 4 Grid Gen
        const c4Grid = document.getElementById('c4-grid');
        for(let i=0; i<42; i++){ const c = document.createElement('div'); c.className='c4-cell'; c4Grid.appendChild(c); }

        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').innerText = now.getHours() + ":" + (now.getMinutes()<10?'0':'')+now.getMinutes();
        }, 1000);
    </script>
</body>
</html>
