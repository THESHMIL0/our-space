<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <title>Our Space OS</title>
    <style>
        :root { --primary: #ff4757; --ios-blue: #007aff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); overflow: hidden; color: #333; height: 100vh; height: 100dvh; display: flex; flex-direction: column; padding-bottom: env(safe-area-inset-bottom); transition: transform 0.1s; }
        
        @keyframes shake { 0% { transform: translate(2px, 2px) rotate(0deg); } 10% { transform: translate(-2px, -3px) rotate(-1deg); } 20% { transform: translate(-4px, 0px) rotate(1deg); } 30% { transform: translate(4px, 3px) rotate(0deg); } 40% { transform: translate(2px, -2px) rotate(1deg); } 50% { transform: translate(-2px, 3px) rotate(-1deg); } 60% { transform: translate(-4px, 2px) rotate(0deg); } 70% { transform: translate(4px, 2px) rotate(-1deg); } 80% { transform: translate(-2px, -2px) rotate(1deg); } 90% { transform: translate(2px, 3px) rotate(0deg); } 100% { transform: translate(2px, -3px) rotate(-1deg); } }
        .shake-screen { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        .shake-element { animation: shake 0.5s infinite; }
        
        @keyframes fastSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(1080deg); } }
        .spinning { animation: fastSpin 2s cubic-bezier(0.2, 0.8, 0.2, 1); }

        /* MUSIC EQUALIZER ANIMATION */
        .equalizer { display: inline-flex; align-items: flex-end; gap: 3px; height: 14px; margin-right: 8px; }
        .eq-bar { width: 3px; background-color: #1db954; border-radius: 2px; animation: bounceBar 1s infinite ease-in-out alternate; }
        .eq-bar:nth-child(1) { height: 6px; animation-delay: 0.1s; }
        .eq-bar:nth-child(2) { height: 14px; animation-delay: 0.3s; }
        .eq-bar:nth-child(3) { height: 8px; animation-delay: 0.5s; }
        @keyframes bounceBar { 0% { height: 4px; } 100% { height: 14px; } }

        /* PLANT PROGRESS BAR */
        .progress-bg { width: 80%; height: 12px; background: #e0e0e0; border-radius: 10px; margin: 15px auto; overflow: hidden; box-shadow: inset 0 2px 5px rgba(0,0,0,0.1); }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #d4fc79 0%, #96e6a1 100%); width: 0%; transition: width 0.5s ease; }

        #dynamic-island { position: fixed; top: max(12px, env(safe-area-inset-top)); left: 50%; transform: translateX(-50%); width: 130px; height: 35px; background: black; border-radius: 30px; z-index: 100000; transition: 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: 600; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); pointer-events: none; }
        .island-active { width: 90%; height: 65px; justify-content: flex-start; padding: 0 20px; box-sizing: border-box; }
        #island-text { opacity: 0; transition: 0.3s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        .island-active #island-text { opacity: 1; transition-delay: 0.2s; }

        #status-bar { display: flex; justify-content: space-between; padding: 15px 30px; font-weight: 600; color: rgba(0,0,0,0.6); font-size: 13px; padding-top: calc(15px + env(safe-area-inset-top)); }
        
        .locket-widget { grid-column: span 4; height: 160px; background: rgba(255,255,255,0.3); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.4); border-radius: 35px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.08); margin-bottom: 5px; cursor: pointer; flex-direction: column; color: rgba(0,0,0,0.5); font-weight: bold; font-size: 14px; }
        .locket-widget img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; display: none; z-index: 2; transition: opacity 0.3s; }
        .locket-widget:active { transform: scale(0.97); }

        #home-screen { flex: 1; padding: 10px 25px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px 15px; align-content: start; }
        .home-app { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .home-icon { width: 60px; height: 60px; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 32px; box-shadow: 0 6px 20px rgba(0,0,0,0.12); margin-bottom: 6px; transition: 0.2s; position: relative; overflow: hidden; }
        .home-icon:active { transform: scale(0.9); filter: brightness(0.8); }
        .app-label { font-size: 11px; font-weight: 600; color: #444; text-align: center; letter-spacing: 0.3px; text-shadow: 0 1px 5px rgba(255,255,255,0.6); }

        #dock { background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); margin: 10px 20px 30px 20px; border-radius: 40px; padding: 15px; display: flex; justify-content: space-around; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.5); }
        .dock-icon { width: 60px; height: 60px; background: white; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 32px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.08); transition: 0.2s; }
        .dock-icon:active { transform: scale(0.9); }
        
        .app-window { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f2f2f7; display: none; flex-direction: column; z-index: 100; animation: slideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes slideUp { from { transform: translateY(100%); border-radius: 40px; } to { transform: translateY(0); border-radius: 0; } }
        .app-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.7); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border-bottom: 1px solid rgba(0,0,0,0.1); font-weight: 600; font-size: 17px; padding-top: calc(15px + env(safe-area-inset-top)); z-index: 10; position: relative; }
        .app-title { position: absolute; left: 50%; transform: translateX(-50%); font-weight: 600; color: #000; }
        .done-btn { color: var(--ios-blue); cursor: pointer; font-size: 17px; font-weight: 500; z-index: 2; }
        
        .chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .bubble { max-width: 75%; padding: 12px 18px; border-radius: 22px; font-size: 16px; line-height: 1.4; position: relative; }
        .me { align-self: flex-end; background: linear-gradient(135deg, #007aff 0%, #0056b3 100%); color: white; border-bottom-right-radius: 6px; box-shadow: 0 4px 12px rgba(0, 122, 255, 0.25); }
        .them { align-self: flex-start; background: #e9e9eb; color: black; border-bottom-left-radius: 6px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .msg-time { display: block; font-size: 10px; opacity: 0.6; margin-top: 5px; text-align: right; }
        .them .msg-time { text-align: left; }
        
        .typing-bubble { display: flex; align-items: center; gap: 4px; padding: 15px 20px !important; }
        .typing-dot { width: 6px; height: 6px; background: #888; border-radius: 50%; animation: typingBounce 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; } .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typingBounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        .input-area { padding: 15px; border-top: 1px solid #ccc; display: flex; gap: 10px; background: #f8f9fa; padding-bottom: calc(30px + env(safe-area-inset-bottom)); }
        .chat-input { flex: 1; padding: 12px 20px; border-radius: 25px; border: 1px solid #ddd; outline: none; background: #fff; font-size: 16px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.02); }

        #ttt-status { font-size: 22px; font-weight: 800; color: #333; margin: 15px 0 5px 0; transition: 0.3s; }
        #ttt-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; width: 280px; margin: 15px auto 30px auto; }
        .cell { width: 85px; height: 85px; background: white; border-radius: 22px; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: 0.2s;}
        .cell:active { transform: scale(0.95); }
        .winning-cell { background: #ffeaa7 !important; transform: scale(1.05); box-shadow: 0 0 20px rgba(253, 203, 110, 0.8) !important; z-index: 10; }

        .game-btn { display:block; margin: 15px auto; padding: 15px 30px; border-radius: 30px; border: none; background: #2f3542; color: white; font-weight: bold; font-size: 16px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: 0.2s; }
        .game-btn:active { transform: scale(0.95); }
        
        #draw-board { border-radius: 20px; background: white; touch-action: none; margin: 10px auto; display: block; box-shadow: 0 5px 20px rgba(0,0,0,0.06); }
        .draw-tools { display: flex; justify-content: center; align-items: center; gap: 12px; margin-bottom: 15px; }
        .color-btn { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 3px solid transparent; transition: 0.2s; }
        .color-btn:active { transform: scale(0.9); }
        .eraser-btn { padding: 8px 15px; border-radius: 20px; background: white; border: 1px solid #ccc; font-weight: bold; font-size: 14px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .floating-heart { position: fixed; bottom: -50px; font-size: 50px; animation: floatUp 3s ease-in forwards; z-index: 1000; pointer-events: none; text-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1) rotate(0deg); opacity: 1; } 100% { transform: translateY(-100vh) scale(1.5) rotate(20deg); opacity: 0; } }
    </style>
</head>
<body>
    <div id="dynamic-island"><span id="island-text">Notification</span></div>

    <div id="status-bar">
        <span id="clock">12:00</span>
        <span style="display:flex; gap: 8px; align-items:center;">
            <span>5G</span>
            <div style="width: 22px; height: 11px; border: 1px solid rgba(0,0,0,0.5); border-radius: 3px; position: relative;">
                <div style="background: rgba(0,0,0,0.7); width: 80%; height: 100%; border-radius: 1px;"></div>
                <div style="position:absolute; right:-3px; top:3px; width:2px; height:4px; background:rgba(0,0,0,0.5); border-radius:1px;"></div>
            </div>
        </span>
    </div>

    <div style="text-align:center; padding: 5px 0 15px 0; font-weight:600; color:white; font-size: 14px; text-shadow:0 1px 5px rgba(0,0,0,0.3); opacity: 0.9;">
        <span>Mood: <span id="partner-mood-display">üòä</span></span> <span style="margin: 0 5px;">|</span>
        <span>Batt: <span id="partner-battery-display">100% üîã</span></span> <span style="margin: 0 5px;">|</span>
        <span style="display:inline-flex; align-items:center;">
            <div id="music-eq" class="equalizer" style="display:none;">
                <div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div>
            </div>
            <span id="music-display">Silence ü§´</span>
        </span>
    </div>

    <div id="home-screen">
        <div class="locket-widget" onclick="document.getElementById('locket-input').click()">
            <span style="font-size: 35px; margin-bottom: 5px;">üñºÔ∏è</span>Tap to update Locket
            <img id="locket-display" src="" />
            <input type="file" id="locket-input" accept="image/*" style="display:none;" onchange="sendLocket(event)">
        </div>

        <div class="home-app" onclick="openApp('musicApp')"><div class="home-icon" style="background: linear-gradient(135deg, #1db954 0%, #191414 100%); color:white;">üéµ</div><div class="app-label">Music</div></div>
        <div class="home-app" onclick="openApp('plantApp')"><div class="home-icon" style="background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);">ü™¥</div><div class="app-label">Plant</div></div>
        <div class="home-app" onclick="openApp('dateApp')"><div class="home-icon" style="background: linear-gradient(135deg, #ff0844 0%, #ffb199 100%); color:white;">üçø</div><div class="app-label">Date Night</div></div>
        <div class="home-app" onclick="openApp('countApp')"><div class="home-icon" style="background: linear-gradient(135deg, #fccb90 0%, #d57eeb 100%); color:white;">‚è≥</div><div class="app-label">Timer</div></div>
        
        <div class="home-app" onclick="openApp('magicApp')"><div class="home-icon" style="background: linear-gradient(135deg, #434343 0%, #000000 100%); color:white;">üé±</div><div class="app-label">8-Ball</div></div>
        <div class="home-app" onclick="openApp('moodApp')"><div class="home-icon" style="background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);">üé≠</div><div class="app-label">Mood</div></div>
        <div class="home-app" onclick="openGameApp('ttt', 'Tic-Tac-Toe')"><div class="home-icon" style="background: linear-gradient(135deg, #74ebd5 0%, #9face6 100%); color: white;">‚ùå‚≠ï</div><div class="app-label">Tic-Tac</div></div>
        <div class="home-app" onclick="openGameApp('draw', 'Drawing Canvas')"><div class="home-icon" style="background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);">üé®</div><div class="app-label">Draw</div></div>
    </div>

    <div id="dock">
        <div class="dock-icon" onclick="openApp('messageApp')">üí¨</div>
        <div class="dock-icon" onclick="triggerBuzz()" style="background: #f1c40f; color: white;">üì≥</div>
        <div class="dock-icon" onclick="triggerHeart()" style="background: var(--primary); color: white;">‚ù§Ô∏è</div>
    </div>

    <div id="musicApp" class="app-window">
        <div class="app-header"><div style="width:40px;"></div><span class="app-title">Music Sync</span><span class="done-btn" onclick="closeApp('musicApp')">Done</span></div>
        <div style="padding: 30px; text-align: center;">
            <div style="font-size: 70px; margin-bottom: 20px;">üéß</div>
            <h3 style="color:#333;">What are you listening to?</h3>
            <input id="song-input" class="chat-input" placeholder="e.g., Taylor Swift - Lover" style="width:90%; margin:20px 0; text-align: center;">
            <button class="game-btn" style="background:#1db954;" onclick="setMusic()">Sync Status</button>
            <button class="game-btn" style="background:#ccc; color:#333;" onclick="clearMusic()">Clear Music</button>
        </div>
    </div>

    <div id="plantApp" class="app-window">
        <div class="app-header"><div style="width:40px;"></div><span class="app-title">Our Plant</span><span class="done-btn" onclick="closeApp('plantApp')">Done</span></div>
        <div style="padding: 40px 20px; text-align: center;">
            <div id="plant-emoji" style="font-size: 110px; margin-bottom: 10px; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);">üå±</div>
            <h2 style="color:#2ed573; margin-bottom: 5px;">Level: <span id="plant-level-text">0</span></h2>
            
            <div class="progress-bg"><div id="plant-progress" class="progress-fill"></div></div>
            <p style="color:#888; font-size: 13px; margin-top:0;">Next evolution at level <span id="next-evo">10</span>!</p>
            
            <button class="game-btn" style="background:#1e90ff; font-size:20px; padding: 20px 40px; margin-top: 30px; box-shadow: 0 10px 20px rgba(30, 144, 255, 0.3);" onclick="waterPlant()">Water üíß</button>
        </div>
    </div>

    <div id="dateApp" class="app-window">
        <div class="app-header"><div style="width:40px;"></div><span class="app-title">Date Roulette</span><span class="done-btn" onclick="closeApp('dateApp')">Done</span></div>
        <div style="padding: 40px 20px; text-align: center;">
            <div id="roulette-emoji" style="font-size: 80px; margin-bottom: 20px; display:inline-block;">üé≤</div>
            <h3 style="color:#333; margin: 20px 0;">Can't decide on date night?</h3>
            <p style="color:#666; font-size: 14px; margin-bottom: 30px;">We'll randomly pick dinner & activity!</p>
            <button class="game-btn" style="background:#ff4757; font-size:18px; padding: 18px 40px;" onclick="spinDate()">Spin the Wheel!</button>
        </div>
    </div>

    <div id="countApp" class="app-window">
        <div class="app-header"><div style="width:40px;"></div><span class="app-title">Countdown</span><span class="done-btn" onclick="closeApp('countApp')">Done</span></div>
        <div style="padding: 30px 20px; text-align: center;">
            
            <div style="background: white; border-radius: 30px; padding: 40px 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 30px;">
                <h1 id="countdown-display" style="font-size: 70px; color: var(--ios-blue); margin:0; font-weight: 800; letter-spacing: -2px;">0</h1>
                <h3 style="color:#888; margin-top:5px; text-transform: uppercase; font-size: 14px; letter-spacing: 2px;">Days Left</h3>
            </div>
            
            <p style="font-weight: bold; color: #555;">Set Target Date:</p>
            <input type="date" id="date-input" class="chat-input" style="width:80%; margin:10px 0 20px 0; text-align: center;">
            <button class="game-btn" onclick="setCountdown()">Start Countdown</button>
        </div>
    </div>

    <div id="magicApp" class="app-window">
        <div class="app-header"><div style="width:40px;"></div><span class="app-title">Magic 8-Ball</span><span class="done-btn" onclick="closeApp('magicApp')">Done</span></div>
        <div style="padding: 40px 20px; text-align: center;">
            <div id="eightball-emoji" style="font-size: 90px; margin-bottom: 30px; display: inline-block;">üé±</div>
            <input id="eightball-input" class="chat-input" placeholder="Ask a yes/no question..." style="width:90%; margin-bottom: 30px; text-align: center;">
            <button class="game-btn" style="background: #2c3e50; padding: 18px 50px; font-size: 18px;" onclick="shake8Ball()">Shake & Reveal</button>
        </div>
    </div>

    <div id="moodApp" class="app-window"><div class="app-header"><div style="width:40px;"></div><span class="app-title">Set Mood</span><span class="done-btn" onclick="closeApp('moodApp')">Done</span></div><div style="padding: 30px 20px; text-align: center;"><h3 style="color:#333; margin-bottom: 25px;">How are you feeling?</h3><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"><button class="game-btn" onclick="setMood('Happy üòä')" style="margin:0; width:100%; background:#7bed9f; color:black;">Happy üòä</button><button class="game-btn" onclick="setMood('Miss You ü•∫')" style="margin:0; width:100%; background:#ff7f50; color:white;">Miss You ü•∫</button><button class="game-btn" onclick="setMood('Sleepy üò¥')" style="margin:0; width:100%; background:#a4b0be; color:white;">Sleepy üò¥</button><button class="game-btn" onclick="setMood('Busy üíª')" style="margin:0; width:100%; background:#ff4757; color:white;">Busy üíª</button></div></div></div>
    
    <div id="messageApp" class="app-window">
        <div class="app-header"><div style="width:40px;"></div><span class="app-title">Messages</span><span class="done-btn" onclick="closeApp('messageApp')">Done</span></div>
        <div id="main-chat" class="chat-container"></div>
        <div class="input-area"><input id="main-input" class="chat-input" placeholder="iMessage" autocomplete="off" oninput="handleTyping()" /><button onclick="sendMessage('main-input')" style="background:var(--ios-blue); color:white; border:none; border-radius:50%; width:40px; height:40px; font-weight:bold;">‚Üë</button></div>
    </div>
    
    <div id="gamesApp" class="app-window">
        <div class="app-header"><div style="width:40px;"></div><span id="game-title" class="app-title">App</span><span class="done-btn" onclick="closeApp('gamesApp')">Done</span></div>
        <div id="game-screens" style="text-align: center; border-bottom: 1px solid #ddd; padding-bottom: 20px; background: white;">
            <div id="screen-ttt"><h3 id="ttt-status">X's Turn</h3><div id="ttt-grid"><div class="cell" onclick="makeMove(0)"></div><div class="cell" onclick="makeMove(1)"></div><div class="cell" onclick="makeMove(2)"></div><div class="cell" onclick="makeMove(3)"></div><div class="cell" onclick="makeMove(4)"></div><div class="cell" onclick="makeMove(5)"></div><div class="cell" onclick="makeMove(6)"></div><div class="cell" onclick="makeMove(7)"></div><div class="cell" onclick="makeMove(8)"></div></div><button class="game-btn" onclick="resetGame()">Restart Game</button></div>
            <div id="screen-draw" style="display:none; padding-top: 15px;">
                <div class="draw-tools"><input type="color" id="color-picker" value="#ff4757" style="width: 35px; height: 35px; border: none; border-radius: 50%; cursor: pointer;" onchange="setBrush(this.value)"><div class="color-btn" style="background:#2ed573;" onclick="setBrush('#2ed573')"></div><div class="color-btn" style="background:#1e90ff;" onclick="setBrush('#1e90ff')"></div><div class="color-btn" style="background:#2f3542;" onclick="setBrush('#2f3542')"></div><button class="eraser-btn" onclick="setBrush('#ffffff')">Eraser</button></div>
                <div class="draw-tools" style="margin-bottom: 15px;"><span style="font-size: 14px; font-weight: bold; color: #555;">Thickness:</span><input type="range" id="brush-size" style="width: 120px;" min="2" max="20" value="4" onchange="updateSize(this.value)"></div>
                <canvas id="draw-board" width="280" height="280"></canvas>
                <button class="game-btn" style="background: #ff9f43;" onclick="clearCanvas()">Erase Canvas</button>
            </div>
        </div>
        <div id="mini-chat" class="chat-container" style="background: #f2f2f7; padding: 10px; flex: 1;"></div>
        <div class="input-area" style="padding: 10px; background:white;"><input id="mini-input" class="chat-input" placeholder="Trash talk..." autocomplete="off" oninput="handleTyping()" /><button onclick="sendMessage('mini-input')" style="background:#2ed573; color:white; border:none; border-radius:50%; width:40px; height:40px; font-weight:bold;">‚Üë</button></div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();
        
        setInterval(() => { const now = new Date(); let h = now.getHours(); let m = now.getMinutes(); document.getElementById('clock').innerText = (h % 12 || 12) + ':' + (m < 10 ? '0'+m : m); }, 1000);

        function openApp(id) { document.getElementById(id).style.display = 'flex'; }
        function closeApp(id) { document.getElementById(id).style.display = 'none'; }
        function openGameApp(gameId, title) {
            document.getElementById('game-title').innerText = title;
            ['ttt', 'draw'].forEach(id => document.getElementById('screen-' + id).style.display = 'none');
            document.getElementById('screen-' + gameId).style.display = 'block'; openApp('gamesApp');
        }

        socket.on('notification', (text) => {
            const island = document.getElementById('dynamic-island'); document.getElementById('island-text').innerText = text;
            island.classList.add('island-active'); if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
            setTimeout(() => { island.classList.remove('island-active'); }, 4000);
        });

        if ('getBattery' in navigator) { navigator.getBattery().then(function(battery) { function updateBattery() { let level = Math.round(battery.level * 100) + "%"; let icon = battery.charging ? "‚ö°" : "üîã"; socket.emit('update battery', level + " " + icon); } updateBattery(); battery.addEventListener('levelchange', updateBattery); battery.addEventListener('chargingchange', updateBattery); }); }
        socket.on('battery update', (batt) => { document.getElementById('partner-battery-display').innerText = batt; });
        function triggerBuzz() { socket.emit('send buzz'); }
        socket.on('receive buzz', () => { if (navigator.vibrate) navigator.vibrate([500, 200, 500]); document.body.classList.add('shake-screen'); setTimeout(() => { document.body.classList.remove('shake-screen'); }, 500); });
        function sendLocket(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { socket.emit('update locket', e.target.result); }; reader.readAsDataURL(file); }
        socket.on('locket update', (imgData) => { const imgEl = document.getElementById('locket-display'); if(imgData) { imgEl.src = imgData; imgEl.style.display = 'block'; } });
        function setMood(mood) { socket.emit('set mood', mood); closeApp('moodApp'); }
        socket.on('mood update', mood => { document.getElementById('partner-mood-display').innerText = mood; });

        // --- üéµ MUSIC APP ---
        function setMusic() { 
            const song = document.getElementById('song-input').value; 
            if(song) { socket.emit('set music', song); document.getElementById('song-input').value = ""; closeApp('musicApp'); } 
        }
        function clearMusic() { socket.emit('set music', 'Silence ü§´'); closeApp('musicApp'); }
        socket.on('music update', song => { 
            document.getElementById('music-display').innerText = song; 
            // Turn on/off equalizer animation based on if a song is playing
            if(song === 'Silence ü§´') document.getElementById('music-eq').style.display = 'none';
            else document.getElementById('music-eq').style.display = 'inline-flex';
        });

        // --- ü™¥ PLANT APP ---
        function waterPlant() { socket.emit('water plant'); }
        socket.on('plant update', level => {
            document.getElementById('plant-level-text').innerText = level;
            
            // Emoji evolution logic
            let emoji = "üå±"; let nextEvo = 10;
            if(level >= 10) { emoji = "üåø"; nextEvo = 30; }
            if(level >= 30) { emoji = "ü™¥"; nextEvo = 60; }
            if(level >= 60) { emoji = "üå∏"; nextEvo = 100; }
            if(level >= 100) { emoji = "üå≥"; nextEvo = "MAX"; }
            
            document.getElementById('plant-emoji').innerText = emoji;
            document.getElementById('next-evo').innerText = nextEvo;
            
            // Progress Bar Math
            let progress = 100;
            if(nextEvo !== "MAX") {
                let prevEvo = 0;
                if(level >= 10) prevEvo = 10;
                if(level >= 30) prevEvo = 30;
                if(level >= 60) prevEvo = 60;
                progress = ((level - prevEvo) / (nextEvo - prevEvo)) * 100;
            }
            document.getElementById('plant-progress').style.width = progress + '%';

            // Watering Bounce Animation
            let p = document.getElementById('plant-emoji');
            p.style.transform = "scale(1.2) translateY(-10px)"; 
            setTimeout(() => p.style.transform = "scale(1) translateY(0)", 200);
        });

        // --- ‚è≥ COUNTDOWN APP ---
        function setCountdown() { const date = document.getElementById('date-input').value; if(date) { socket.emit('set countdown', date); closeApp('countApp'); } }
        socket.on('countdown update', targetDate => {
            setInterval(() => {
                const diff = new Date(targetDate) - new Date();
                const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
                document.getElementById('countdown-display').innerText = days > 0 ? days : 0;
            }, 1000);
        });

        // --- üçø DATE ROULETTE ---
        const dinners = ["Sushi üç£", "Italian üçù", "Burgers üçî", "Tacos üåÆ", "Cook Together üç≥"];
        const activities = ["Netflix Movie üçø", "Board Games üé≤", "Late Night Walk üåô", "Deep Talk üó£Ô∏è", "Video Games üéÆ"];
        function spinDate() {
            let r = document.getElementById('roulette-emoji');
            r.classList.add('spinning'); // Add CSS spin class
            
            // Wait for 2 second animation to finish before announcing
            setTimeout(() => {
                r.classList.remove('spinning');
                let d = dinners[Math.floor(Math.random() * dinners.length)];
                let a = activities[Math.floor(Math.random() * activities.length)];
                let msg = `üé≤ **Date Night Pick!**\nüçΩÔ∏è Dinner: ${d}\nüé¨ Activity: ${a}`;
                addMessageToBoth(msg, 'me'); socket.emit('chat message', {text: msg}); closeApp('dateApp');
            }, 2000);
        }

        // --- üé± MAGIC 8-BALL ---
        const answers = ["Yes, definitely! ‚ú®", "No way. üôÖ", "Ask again later ‚è≥", "It is certain üíØ", "Very doubtful üò¨", "Absolutely! ‚ù§Ô∏è"];
        function shake8Ball() {
            let q = document.getElementById('eightball-input').value; if(!q) return;
            let ball = document.getElementById('eightball-emoji');
            ball.classList.add('shake-element'); // Add CSS shake class
            
            // Wait for 1 second shake animation
            setTimeout(() => {
                ball.classList.remove('shake-element');
                let a = answers[Math.floor(Math.random() * answers.length)];
                let msg = `üé± **Question:** ${q}\n‚ú® **Answer:** ${a}`;
                addMessageToBoth(msg, 'me'); socket.emit('chat message', {text: msg});
                document.getElementById('eightball-input').value = ""; closeApp('magicApp');
            }, 1000);
        }

        // Chat & Games
        function addMessageToBoth(text, type) { const now = new Date(); let hours = now.getHours(); let ampm = hours >= 12 ? 'PM' : 'AM'; hours = hours % 12 || 12; let mins = now.getMinutes() < 10 ? '0' + now.getMinutes() : now.getMinutes(); let timeStr = hours + ':' + mins + ' ' + ampm; const createBubble = () => { var div = document.createElement('div'); div.className = 'bubble ' + type; div.innerHTML = text.replace(/\n/g, '<br>') + `<span class="msg-time">${timeStr}</span>`; return div; }; let mainChat = document.getElementById('main-chat'); mainChat.appendChild(createBubble()); mainChat.scrollTop = mainChat.scrollHeight; let miniChat = document.getElementById('mini-chat'); miniChat.appendChild(createBubble()); miniChat.scrollTop = miniChat.scrollHeight; let typingBubbles = document.querySelectorAll('.typing-bubble-container'); typingBubbles.forEach(b => b.remove()); }
        function sendMessage(inputId) { var inputField = document.getElementById(inputId); if(inputField.value) { addMessageToBoth(inputField.value, 'me'); socket.emit('chat message', {text: inputField.value}); inputField.value = ''; socket.emit('stop typing'); } }
        socket.on('chat message', d => addMessageToBoth(d.text, 'them'));
        let typingTimer; function handleTyping() { socket.emit('typing'); clearTimeout(typingTimer); typingTimer = setTimeout(() => socket.emit('stop typing'), 1500); }
        socket.on('typing', () => { if (!document.getElementById('typing-indicator')) { let div = document.createElement('div'); div.id = 'typing-indicator'; div.className = 'bubble them typing-bubble typing-bubble-container'; div.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>'; let mainChat = document.getElementById('main-chat'); mainChat.appendChild(div); mainChat.scrollTop = mainChat.scrollHeight; } });
        socket.on('stop typing', () => { let indicator = document.getElementById('typing-indicator'); if (indicator) indicator.remove(); });
        function triggerHeart() { socket.emit('send heart'); }
        socket.on('show heart', () => { const heart = document.createElement('div'); heart.innerText = '‚ù§Ô∏è'; heart.className = 'floating-heart'; heart.style.left = Math.random() * 80 + 10 + 'vw'; document.body.appendChild(heart); setTimeout(() => heart.remove(), 3000); });

        let currentTurn = 'X'; let localGameState = Array(9).fill(null); let gameActive = true; function makeMove(idx) { if (localGameState[idx] || !gameActive) return; socket.emit('make move', { index: idx, symbol: currentTurn }); } socket.on('game update', state => { localGameState = state; const cells = document.querySelectorAll('#ttt-grid .cell'); let xCount = 0; let oCount = 0; cells.forEach(c => c.classList.remove('winning-cell')); state.forEach((val, i) => { cells[i].innerText = val || ''; if (val === 'X') xCount++; if (val === 'O') oCount++; cells[i].style.color = val === 'X' ? '#ff4757' : '#2ed573'; }); currentTurn = (xCount > oCount) ? 'O' : 'X'; document.getElementById('ttt-status').innerText = `${currentTurn}'s Turn`; checkWinAndDraw(state); }); function checkWinAndDraw(state) { const winConditions = [ [0,1,2], [3,4,5], [6,7,8], [0,3,6], [1,4,7], [2,5,8], [0,4,8], [2,4,6] ]; let roundWon = false; for (let i = 0; i < winConditions.length; i++) { const winCondition = winConditions[i]; let a = state[winCondition[0]], b = state[winCondition[1]], c = state[winCondition[2]]; if (a === null || b === null || c === null) continue; if (a === b && b === c) { roundWon = true; document.querySelectorAll('#ttt-grid .cell')[winCondition[0]].classList.add('winning-cell'); document.querySelectorAll('#ttt-grid .cell')[winCondition[1]].classList.add('winning-cell'); document.querySelectorAll('#ttt-grid .cell')[winCondition[2]].classList.add('winning-cell'); document.getElementById('ttt-status').innerText = `üéâ ${a} Wins! üéâ`; document.getElementById('ttt-status').style.color = a === 'X' ? '#ff4757' : '#2ed573'; gameActive = false; break; } } if (!roundWon && !state.includes(null)) { document.getElementById('ttt-status').innerText = `It's a Draw! ü§ù`; document.getElementById('ttt-status').style.color = '#333'; gameActive = false; } else if (!roundWon) { gameActive = true; document.getElementById('ttt-status').style.color = '#333'; } } function resetGame() { socket.emit('reset game'); }
        const canvas = document.getElementById('draw-board'); const ctx = canvas.getContext('2d'); ctx.lineCap = 'round'; ctx.lineJoin = 'round'; let drawing = false; let brushColor = '#ff4757'; let brushSize = 4; function setBrush(color) { brushColor = color; } function updateSize(size) { brushSize = size; } function getPos(e) { const rect = canvas.getBoundingClientRect(); return { x: (e.touches ? e.touches[0].clientX : e.clientX) - rect.left, y: (e.touches ? e.touches[0].clientY : e.clientY) - rect.top }; } function startDraw(e) { drawing = true; const pos = getPos(e); socket.emit('draw', { type: 'start', x: pos.x, y: pos.y, color: brushColor, size: brushSize }); ctx.beginPath(); ctx.strokeStyle = brushColor; ctx.lineWidth = brushSize; ctx.moveTo(pos.x, pos.y); e.preventDefault(); } function drawLine(e) { if (!drawing) return; const pos = getPos(e); socket.emit('draw', { type: 'draw', x: pos.x, y: pos.y, color: brushColor, size: brushSize }); ctx.strokeStyle = brushColor; ctx.lineWidth = brushSize; ctx.lineTo(pos.x, pos.y); ctx.stroke(); e.preventDefault(); } function stopDraw() { drawing = false; ctx.beginPath(); } canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', drawLine); canvas.addEventListener('mouseup', stopDraw); canvas.addEventListener('touchstart', startDraw, {passive: false}); canvas.addEventListener('touchmove', drawLine, {passive: false}); canvas.addEventListener('touchend', stopDraw); socket.on('draw', data => { if (data.type === 'start') { ctx.beginPath(); ctx.strokeStyle = data.color || '#ff4757'; ctx.lineWidth = data.size || 4; ctx.moveTo(data.x, data.y); } else if (data.type === 'draw') { ctx.strokeStyle = data.color || '#ff4757'; ctx.lineWidth = data.size || 4; ctx.lineTo(data.x, data.y); ctx.stroke(); } else if (data.type === 'clear') { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.beginPath(); } }); function clearCanvas() { socket.emit('draw', { type: 'clear' }); ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.beginPath(); }
    </script>
</body>
</html>
