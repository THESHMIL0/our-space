<!DOCTYPE html>
<html>
<head>
    <title>Our Space</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <style>
        body { font-family: -apple-system, system-ui; margin: 0; background: #f0f0f5; overflow: hidden; }
        #home-screen { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding: 40px 20px; text-align: center; }
        .app-icon { width: 70px; height: 70px; border-radius: 15px; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center; font-size: 35px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .app-label { font-size: 13px; font-weight: 500; }
        .app-window { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: none; flex-direction: column; z-index: 100; }
        .app-header { padding: 15px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .close-btn { color: #007aff; cursor: pointer; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; background: #fff; display: flex; flex-direction: column; }
        .bubble { max-width: 70%; padding: 10px 15px; border-radius: 20px; margin-bottom: 10px; font-size: 16px; line-height: 1.4; }
        .me { align-self: flex-end; background: #007aff; color: white; border-bottom-right-radius: 5px; }
        .them { align-self: flex-start; background: #e9e9eb; color: black; border-bottom-left-radius: 5px; }
        .input-area { padding: 10px; border-top: 1px solid #ddd; display: flex; gap: 10px; }
        #m { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ddd; outline: none; }
        #gallery-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; overflow-y: auto; }
        #gallery-grid img { width: 100%; aspect-ratio: 1; object-fit: cover; }
    </style>
</head>
<body>

    <div id="home-screen">
        <div onclick="openApp('messageApp')">
            <div class="app-icon" style="background: #4cd964; color: white;">üí¨</div>
            <div class="app-label">Messages</div>
        </div>
        <div onclick="openApp('galleryApp')">
            <div class="app-icon" style="background: linear-gradient(135deg, #ffcc00, #ff9500);">üåª</div>
            <div class="app-label">Gallery</div>
        </div>
        <div onclick="openApp('gamesApp')">
            <div class="app-icon" style="background: #5ac8fa; color: white;">üéÆ</div>
            <div class="app-label">Games</div>
        </div>
    </div>

    <div id="messageApp" class="app-window">
        <div class="app-header"><span>My Love ‚ù§Ô∏è</span><span class="close-btn" onclick="closeApp('messageApp')">Close</span></div>
        <div id="messages"></div>
        <div class="input-area">
            <input id="m" placeholder="iMessage" autocomplete="off" />
            <button onclick="sendMessage()" style="border:none; background:#007aff; color:white; border-radius:50%; width:35px; height:35px;">‚Üë</button>
        </div>
    </div>

    <div id="galleryApp" class="app-window">
        <div class="app-header"><span>Our Gallery</span><span class="close-btn" onclick="closeApp('galleryApp')">Close</span></div>
        <div style="padding: 10px;"><input type="file" id="photoInput" onchange="uploadPhoto()" accept="image/*"></div>
        <div id="gallery-grid"></div>
    </div>

    <div id="gamesApp" class="app-window">
        <div class="app-header"><span>Games</span><span class="close-btn" onclick="closeApp('gamesApp')">Close</span></div>
        <div style="padding: 20px; text-align: center;"><h3>Tic-Tac-Toe Coming Soon!</h3></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();

        function openApp(id) { document.getElementById(id).style.display = 'flex'; }
        function closeApp(id) { document.getElementById(id).style.display = 'none'; }

        function addMessage(text, type) {
            var div = document.createElement('div');
            div.className = 'bubble ' + type;
            div.textContent = text;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        function sendMessage() {
            var input = document.getElementById('m');
            if (input.value) {
                addMessage(input.value, 'me');
                socket.emit('chat message', { text: input.value, sender: 'me' });
                input.value = '';
            }
        }

        socket.on('chat message', function(data) { addMessage(data.text, 'them'); });

        socket.on('load history', function(messages) {
            document.getElementById('messages').innerHTML = '';
            messages.forEach(m => addMessage(m.text, m.sender === 'me' ? 'me' : 'them'));
        });

        function uploadPhoto() {
            var file = document.getElementById('photoInput').files[0];
            var formData = new FormData();
            formData.append('photo', file);
            fetch('/upload', { method: 'POST', body: formData });
        }

        function addPhotoToGrid(url) {
            var img = document.createElement('img');
            img.src = url;
            document.getElementById('gallery-grid').prepend(img);
        }

        socket.on('new photo', function(url) { addPhotoToGrid(url); });
    </script>
</body>
</html>
