<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <title>Our Game OS</title>
    <style>
        :root { --primary: #ff4757; --ios-blue: #007aff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); overflow: hidden; color: #333; height: 100vh; height: 100dvh; display: flex; flex-direction: column; padding-bottom: env(safe-area-inset-bottom); transition: transform 0.1s; }
        
        #sleep-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 10, 25, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); z-index: 99998; display: none; opacity: 0; transition: opacity 1s ease-in-out; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .sleeping #sleep-overlay { display: flex; opacity: 1; }
        .sleep-bounce { animation: bounceBar 2s infinite alternate ease-in-out; }

        @keyframes shake { 0% { transform: translate(2px, 2px) rotate(0deg); } 10% { transform: translate(-2px, -3px) rotate(-1deg); } 20% { transform: translate(-4px, 0px) rotate(1deg); } 30% { transform: translate(4px, 3px) rotate(0deg); } 40% { transform: translate(2px, -2px) rotate(1deg); } 50% { transform: translate(-2px, 3px) rotate(-1deg); } 60% { transform: translate(-4px, 2px) rotate(0deg); } 70% { transform: translate(4px, 2px) rotate(-1deg); } 80% { transform: translate(-2px, -2px) rotate(1deg); } 90% { transform: translate(2px, 3px) rotate(0deg); } 100% { transform: translate(2px, -3px) rotate(-1deg); } }
        .shake-screen { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        .shake-element { animation: shake 0.5s infinite; }
        @keyframes fastSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(1080deg); } }
        .spinning { animation: fastSpin 2s cubic-bezier(0.2, 0.8, 0.2, 1); }

        .progress-bg { width: 80%; height: 12px; background: #e0e0e0; border-radius: 10px; margin: 15px auto; overflow: hidden; box-shadow: inset 0 2px 5px rgba(0,0,0,0.1); }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #d4fc79 0%, #96e6a1 100%); width: 0%; transition: width 0.5s ease; }
        .love-fill { height: 100%; background: linear-gradient(90deg, #ff0844 0%, #ffb199 100%); width: 100%; transition: width 0.5s ease; }

        #dynamic-island { position: fixed; top: max(12px, env(safe-area-inset-top)); left: 50%; transform: translateX(-50%); width: 130px; height: 35px; background: black; border-radius: 30px; z-index: 100000; transition: 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: 600; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); pointer-events: none; }
        .island-active { width: 90%; height: 65px; justify-content: flex-start; padding: 0 20px; box-sizing: border-box; }
        #island-text { opacity: 0; transition: 0.3s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        .island-active #island-text { opacity: 1; transition-delay: 0.2s; }

        #status-bar { display: flex; justify-content: space-between; padding: 15px 30px; font-weight: 600; color: rgba(0,0,0,0.6); font-size: 13px; padding-top: calc(15px + env(safe-area-inset-top)); }
        .locket-widget { grid-column: span 4; height: 140px; background: rgba(255,255,255,0.3); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.4); border-radius: 35px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.08); margin-bottom: 0px; cursor: pointer; flex-direction: column; color: rgba(0,0,0,0.5); font-weight: bold; font-size: 14px; }
        .locket-widget img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; display: none; z-index: 2; transition: opacity 0.3s; }
        
        #home-screen { flex: 1; padding: 10px 25px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px 12px; align-content: start; overflow-y: auto; }
        .home-app { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .home-icon { width: 55px; height: 55px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 6px 20px rgba(0,0,0,0.12); margin-bottom: 6px; transition: 0.2s; position: relative; overflow: hidden; }
        .app-label { font-size: 11px; font-weight: 600; color: #444; text-align: center; }

        #dock { background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); margin: 5px 20px 20px 20px; border-radius: 40px; padding: 15px; display: flex; justify-content: space-around; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.5); }
        .dock-icon { width: 60px; height: 60px; background: white; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 32px; cursor: pointer; transition: 0.2s; }

        .app-window { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f2f2f7; display: none; flex-direction: column; z-index: 100; animation: slideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes slideUp { from { transform: translateY(100%); border-radius: 40px; } to { transform: translateY(0); border-radius: 0; } }
        .app-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.7); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border-bottom: 1px solid rgba(0,0,0,0.1); font-weight: 600; font-size: 17px; padding-top: calc(15px + env(safe-area-inset-top)); z-index: 10; position: relative; }
        .app-title { position: absolute; left: 50%; transform: translateX(-50%); font-weight: 600; color: #000; }
        .done-btn { color: var(--ios-blue); cursor: pointer; font-size: 17px; font-weight: 500; z-index: 2; }

        .chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .bubble { max-width: 75%; padding: 12px 18px; border-radius: 22px; font-size: 16px; line-height: 1.4; position: relative; }
        .me { align-self: flex-end; background: linear-gradient(135deg, #007aff 0%, #0056b3 100%); color: white; border-bottom-right-radius: 6px; }
        .them { align-self: flex-start; background: #e9e9eb; color: black; border-bottom-left-radius: 6px; }
        .msg-time { display: block; font-size: 10px; opacity: 0.6; margin-top: 5px; text-align: right; }
        
        #mem-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 300px; margin: 20px auto; }
        .mem-card { width: 65px; height: 65px; background: var(--ios-blue); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 35px; cursor: pointer; color: transparent; transition: 0.3s; }
        .mem-card.flipped { background: white; color: black; transform: rotateY(180deg); }
        .mem-card.matched { background: #e0e0e0; color: black; opacity: 0.6; }

        #c4-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; background: #1e90ff; padding: 10px; border-radius: 15px; width: max-content; margin: 15px auto; }
        .c4-cell { width: 38px; height: 38px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; }
        .winning-cell { background: #ffeaa7 !important; transform: scale(1.05); box-shadow: 0 0 20px rgba(253, 203, 110, 0.8) !important; }
    </style>
</head>
<body>
    <div id="sleep-overlay">
        <div class="sleep-bounce" style="font-size: 90px; margin-bottom: 10px;">üò¥</div>
        <h2 style="color: white; font-weight: 600; margin-bottom: 5px;">Partner is sleeping</h2>
        <button class="game-btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.4); padding: 15px 40px; backdrop-filter: blur(10px);" onclick="forceWakeUp()">Wake Up / Dismiss ‚òÄÔ∏è</button>
    </div> 

    <div id="dynamic-island"><span id="island-text">Notification</span></div>
    <div id="status-bar"><span id="clock">12:00</span><span style="display:flex; gap: 8px; align-items:center;"><span>5G</span><div style="width: 22px; height: 11px; border: 1px solid rgba(0,0,0,0.5); border-radius: 3px; position: relative;"><div style="background: rgba(0,0,0,0.7); width: 80%; height: 100%; border-radius: 1px;"></div></div></span></div>

    <div style="text-align:center; padding: 5px 0 10px 0; font-weight:600; color:white; font-size: 13px; text-shadow:0 1px 5px rgba(0,0,0,0.3); opacity: 0.9;">
        <span>Battery: <span id="partner-battery-display">100% üîã</span></span> <span style="margin: 0 5px;">|</span>
        <span>Love: <span id="partner-love-display">100% üíñ</span></span>
    </div>

    <div id="home-screen">
        <div class="locket-widget" onclick="document.getElementById('locket-input').click()">
            <span style="font-size: 35px; margin-bottom: 5px;">üñºÔ∏è</span>Tap to update Locket
            <img id="locket-display" src="" />
            <input type="file" id="locket-input" accept="image/*" style="display:none;" onchange="sendLocket(event)">
        </div>

        <div class="home-app" onclick="openApp('plantApp')"><div class="home-icon" style="background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);">ü™¥</div><div class="app-label">Plant</div></div>
        <div class="home-app" onclick="openApp('wyrApp')"><div class="home-icon" style="background: linear-gradient(135deg, #f83600 0%, #f9d423 100%); color:white;">ü§î</div><div class="app-label">Questions</div></div>
        <div class="home-app" onclick="openApp('loveApp')"><div class="home-icon" style="background: linear-gradient(135deg, #ff758c 0%, #ff7eb3 100%); color:white;">üíñ</div><div class="app-label">Love Meter</div></div>
        <div class="home-app" onclick="openApp('sleepApp')"><div class="home-icon" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color:white;">üåô</div><div class="app-label">Sleep Sync</div></div>
        <div class="home-app" onclick="openApp('magicApp')"><div class="home-icon" style="background: linear-gradient(135deg, #434343 0%, #000000 100%); color:white;">üé±</div><div class="app-label">8-Ball</div></div>
        <div class="home-app" onclick="openGameApp('mem', 'Memory Match')"><div class="home-icon" style="background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);">üß†</div><div class="app-label">Memory</div></div>
        <div class="home-app" onclick="openGameApp('qd', 'Quick Draw')"><div class="home-icon" style="background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);">‚ö°</div><div class="app-label">Reaction</div></div>
        <div class="home-app" onclick="openGameApp('balloon', 'Pop Balloon')"><div class="home-icon" style="background: linear-gradient(135deg, #ff0844 0%, #ffb199 100%); color:white;">üéà</div><div class="app-label">Balloon</div></div>
        <div class="home-app" onclick="openGameApp('c4', 'Connect 4')"><div class="home-icon" style="background: linear-gradient(135deg, #f6d365 0%, #ffb199 100%);">üî¥üü°</div><div class="app-label">Connect 4</div></div>
        <div class="home-app" onclick="openGameApp('tap', 'Tap Battle')"><div class="home-icon" style="background: linear-gradient(135deg, #a1c4fd 0%, #ff9a9e 100%);">‚öîÔ∏è</div><div class="app-label">Tap Battle</div></div>
        <div class="home-app" onclick="openGameApp('ttt', 'Tic-Tac-Toe')"><div class="home-icon" style="background: linear-gradient(135deg, #74ebd5 0%, #9face6 100%); color: white;">‚ùå‚≠ï</div><div class="app-label">Tic-Tac</div></div>
        <div class="home-app" onclick="openGameApp('draw', 'Drawing Canvas')"><div class="home-icon" style="background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);">üé®</div><div class="app-label">Draw</div></div>
    </div>

    <div id="dock">
        <div class="dock-icon" onclick="openApp('messageApp')">üí¨</div>
        <div class="dock-icon" onclick="triggerBuzz()" style="background: #f1c40f; color: white;">üì≥</div>
        <div class="dock-icon" onclick="triggerHeart()" style="background: var(--primary); color: white;">‚ù§Ô∏è</div>
    </div>
    <div id="gamesApp" class="app-window">
        <div class="app-header"><div style="width:40px;"></div><span id="game-title" class="app-title">App</span><span class="done-btn" onclick="closeApp('gamesApp')">Done</span></div>
        <div id="game-screens" style="text-align: center; border-bottom: 1px solid #ddd; padding-bottom: 20px; background: white; flex:1; overflow-y:auto;">
            <div id="screen-mem" style="display:none; padding-top: 10px;"><h3>Find the Pairs!</h3><div id="mem-grid"></div><button class="game-btn" onclick="socket.emit('mem reset')">Restart Game</button></div>
            <div id="screen-qd" style="display:none; padding: 20px;"><h3 id="qd-status">Reaction Test!</h3><button id="qd-btn" style="width:200px; height:200px; border-radius:50%; font-size:26px; border:none; color:white; background:#333; margin:30px auto;" onclick="socket.emit('qd start')">START</button></div>
            <div id="screen-balloon" style="display:none; padding: 20px;"><h3>Don't pop it!</h3><div style="height: 250px; display:flex; align-items:center; justify-content:center;"><div id="balloon-emoji" style="font-size: 50px;">üéà</div></div><h2 id="balloon-status"></h2><button id="balloon-btn" class="game-btn" onclick="socket.emit('balloon pump')">PUMP AIR</button></div>
            <div id="screen-c4" style="display:none; padding-top: 10px;"><h3 id="c4-status">üî¥ Red's Turn</h3><div id="c4-grid"></div><button class="game-btn" onclick="socket.emit('c4 reset')">Restart Game</button></div>
            <div id="screen-tap" style="display:none; padding: 20px;"><h2>Tug of War</h2><div style="width: 100%; height: 35px; background: #1e90ff; border-radius: 20px; overflow: hidden; margin: 20px 0;"><div id="tap-bar-red" style="height: 100%; width: 50%; background: #ff4757; transition: width 0.1s;"></div></div><div id="tap-team-select"><button class="game-btn" onclick="joinTap('red')">RED</button><button class="game-btn" onclick="joinTap('blue')">BLUE</button></div><button id="tap-btn" class="game-btn" style="display:none; width:200px; height:200px; border-radius:50%;" onclick="pullTap()">TAP!</button></div>
            <div id="screen-ttt" style="display:none;"><h3 id="ttt-status">X's Turn</h3><div id="ttt-grid" style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 250px; margin: 15px auto;"><div class="cell" onclick="makeMove(0)"></div><div class="cell" onclick="makeMove(1)"></div><div class="cell" onclick="makeMove(2)"></div><div class="cell" onclick="makeMove(3)"></div><div class="cell" onclick="makeMove(4)"></div><div class="cell" onclick="makeMove(5)"></div><div class="cell" onclick="makeMove(6)"></div><div class="cell" onclick="makeMove(7)"></div><div class="cell" onclick="makeMove(8)"></div></div><button class="game-btn" onclick="socket.emit('reset game')">Reset</button></div>
            <div id="screen-draw" style="display:none;"><canvas id="draw-board" width="280" height="280"></canvas><button class="game-btn" onclick="clearCanvas()">Erase</button></div>
        </div>
        <div id="mini-chat" class="chat-container" style="background: #f2f2f7; padding: 10px; height: 200px;"></div>
        <div class="input-area"><input id="mini-input" class="chat-input" placeholder="Trash talk..." /><button onclick="sendMessage('mini-input')" style="background:#2ed573; color:white; border:none; border-radius:50%; width:40px; height:40px;">‚Üë</button></div>
    </div>

    <div id="wyrApp" class="app-window"><div class="app-header"><div style="width:40px;"></div><span class="app-title">Would You Rather?</span><span class="done-btn" onclick="closeApp('wyrApp')">Done</span></div><div style="padding: 40px 20px; text-align: center;"><div style="font-size: 80px;">ü§î</div><button class="game-btn" onclick="generateWYR()">Ask a Question</button></div></div>
    <div id="loveApp" class="app-window"><div class="app-header"><div style="width:40px;"></div><span class="app-title">Love Meter</span><span class="done-btn" onclick="closeApp('loveApp')">Done</span></div><div style="padding: 40px 20px; text-align: center;"><div id="love-heart" style="font-size: 100px;">üíñ</div><div class="progress-bg"><div id="love-progress" class="love-fill"></div></div><button class="game-btn" onclick="chargeLove()">Charge! ‚ö°</button></div></div>
    <div id="sleepApp" class="app-window"><div class="app-header"><div style="width:40px;"></div><span class="app-title">Sleep Sync</span><span class="done-btn" onclick="closeApp('sleepApp')">Done</span></div><div style="padding: 40px 20px; text-align: center;"><div>üò¥</div><button id="sleep-btn" class="game-btn" onclick="toggleSleep()">Go to Sleep üåô</button></div></div>
    <div id="plantApp" class="app-window"><div class="app-header"><div style="width:40px;"></div><span class="app-title">Our Plant</span><span class="done-btn" onclick="closeApp('plantApp')">Done</span></div><div style="padding: 40px 20px; text-align: center;"><div id="plant-emoji" style="font-size: 100px;">üå±</div><h2 id="plant-level-text">0</h2><button class="game-btn" onclick="socket.emit('water plant')">Water üíß</button></div></div>
    <div id="magicApp" class="app-window"><div class="app-header"><div style="width:40px;"></div><span class="app-title">Magic 8-Ball</span><span class="done-btn" onclick="closeApp('magicApp')">Done</span></div><div style="padding: 40px 20px; text-align: center;"><div id="eightball-emoji" style="font-size: 90px;">üé±</div><input id="eightball-input" class="chat-input" placeholder="Ask a question..." /><button class="game-btn" onclick="shake8Ball()">Shake</button></div></div>
    <div id="messageApp" class="app-window"><div class="app-header"><div style="width:40px;"></div><span class="app-title">Messages</span><span class="done-btn" onclick="closeApp('messageApp')">Done</span></div><div id="main-chat" class="chat-container"></div><div class="input-area"><input id="main-input" class="chat-input" placeholder="iMessage" oninput="handleTyping()" /><button onclick="sendMessage('main-input')" style="background:var(--ios-blue); color:white; border:none; border-radius:50%; width:40px; height:40px;">‚Üë</button></div></div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();
        setInterval(() => { const now = new Date(); let h = now.getHours(); let m = now.getMinutes(); document.getElementById('clock').innerText = (h % 12 || 12) + ':' + (m < 10 ? '0'+m : m); }, 1000);
        function openApp(id) { document.getElementById(id).style.display = 'flex'; }
        function closeApp(id) { document.getElementById(id).style.display = 'none'; }
        function openGameApp(gameId, title) { document.getElementById('game-title').innerText = title; ['ttt', 'draw', 'c4', 'tap', 'mem', 'qd', 'balloon'].forEach(id => document.getElementById('screen-' + id).style.display = 'none'); document.getElementById('screen-' + gameId).style.display = 'block'; openApp('gamesApp'); }

        socket.on('notification', (text) => { const island = document.getElementById('dynamic-island'); document.getElementById('island-text').innerText = text; island.classList.add('island-active'); setTimeout(() => { island.classList.remove('island-active'); }, 4000); });
        
        // üîã Battery Sync
        if ('getBattery' in navigator) { navigator.getBattery().then(function(battery) { function updateBattery() { socket.emit('update battery', Math.round(battery.level * 100) + "% " + (battery.charging ? "‚ö°" : "üîã")); } updateBattery(); battery.addEventListener('levelchange', updateBattery); }); }
        socket.on('battery update', (batt) => { document.getElementById('partner-battery-display').innerText = batt; });

        // üß† Memory Match Logic
        socket.on('memory update', data => { const grid = document.getElementById('mem-grid'); grid.innerHTML = ''; data.board.forEach((emoji, i) => { let card = document.createElement('div'); card.className = 'mem-card' + (data.matched.includes(i) ? ' matched' : '') + (data.flipped.includes(i) ? ' flipped' : ''); if(data.matched.includes(i) || data.flipped.includes(i)) card.innerText = emoji; card.onclick = () => socket.emit('mem flip', i); grid.appendChild(card); }); });

        // ‚ö° Quick Draw Logic
        socket.on('qd update', state => { let btn = document.getElementById('qd-btn'); let stat = document.getElementById('qd-status'); if(state === 'idle') { btn.style.background = '#333'; btn.innerText = "START"; stat.innerText = "Ready?"; } else if(state === 'wait') { btn.style.background = '#f1c40f'; btn.innerText = "Wait..."; } else if(state === 'go') { btn.style.background = '#2ed573'; btn.innerText = "TAP!"; } else if(state === 'win') { btn.style.background = '#1e90ff'; btn.innerText = "OVER!"; stat.innerText = "Winner announced!"; } else if(state === 'fail') { btn.style.background = '#ff4757'; btn.innerText = "TOO EARLY!"; } });

        // üéà Balloon Logic (The Fix!)
        socket.on('balloon update', data => { let bal = document.getElementById('balloon-emoji'); let stat = document.getElementById('balloon-status'); let btn = document.getElementById('balloon-btn'); if(data.popped) { bal.innerText = "üí•"; bal.style.transform = "scale(2)"; stat.innerText = (data.popper === socket.id) ? "üí• POPPED! You lose! üí•" : "üéâ THEY POPPED IT! You win! üéâ"; stat.style.color = (data.popper === socket.id) ? "#ff4757" : "#2ed573"; btn.style.display = "none"; } else { bal.innerText = "üéà"; bal.style.transform = `scale(${1 + (data.pumps * 0.15)})`; stat.innerText = ""; btn.style.display = "block"; } });

        // üì≥ Buzz & Hearts
        function triggerBuzz() { socket.emit('send buzz'); } socket.on('receive buzz', () => { document.body.classList.add('shake-screen'); setTimeout(() => { document.body.classList.remove('shake-screen'); }, 500); });
        function triggerHeart() { socket.emit('send heart'); } socket.on('show heart', () => { const heart = document.createElement('div'); heart.innerText = '‚ù§Ô∏è'; heart.className = 'floating-heart'; heart.style.left = Math.random() * 80 + 10 + 'vw'; document.body.appendChild(heart); setTimeout(() => heart.remove(), 3000); });

        // Other Logic (Mood, Locket, Chat, WYR, Love, Sleep)
        function sendLocket(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { socket.emit('update locket', e.target.result); }; reader.readAsDataURL(file); }
        socket.on('locket update', (imgData) => { const imgEl = document.getElementById('locket-display'); if(imgData) { imgEl.src = imgData; imgEl.style.display = 'block'; } });
        function chargeLove() { socket.emit('charge love'); } socket.on('love update', level => { document.getElementById('partner-love-display').innerText = level + "% üíñ"; document.getElementById('love-progress').style.width = level + '%'; });
        function toggleSleep() { socket.emit('toggle sleep', !document.body.classList.contains('sleeping')); closeApp('sleepApp'); }
        socket.on('sleep update', partnerSleeping => { if(partnerSleeping) document.body.classList.add('sleeping'); else document.body.classList.remove('sleeping'); });
        function forceWakeUp() { socket.emit('toggle sleep', false); }
        function sendMessage(inputId) { var inputField = document.getElementById(inputId); if(inputField.value) { addMessageToBoth(inputField.value, 'me'); socket.emit('chat message', {text: inputField.value}); inputField.value = ''; socket.emit('stop typing'); } }
        socket.on('chat message', d => addMessageToBoth(d.text, 'them'));
        function addMessageToBoth(text, type) { const now = new Date(); let hours = now.getHours(); let timeStr = (hours % 12 || 12) + ':' + (now.getMinutes() < 10 ? '0' + now.getMinutes() : now.getMinutes()) + (hours >= 12 ? 'PM' : 'AM'); let mainChat = document.getElementById('main-chat'); let div = document.createElement('div'); div.className = 'bubble ' + type; div.innerHTML = text + `<span class="msg-time">${timeStr}</span>`; mainChat.appendChild(div); mainChat.scrollTop = mainChat.scrollHeight; }

        // Games Retained (C4, Tap, TTT, Draw)
        socket.on('c4 update', state => { const cells = document.querySelectorAll('#c4-grid .c4-cell'); state.forEach((val, i) => { cells[i].innerText = val || ''; }); });
        function joinTap(team) { myTapTeam = team; document.getElementById('tap-team-select').style.display = 'none'; document.getElementById('tap-btn').style.display = 'block'; }
        function pullTap() { socket.emit('tap pull', myTapTeam); }
        socket.on('tap update', score => { document.getElementById('tap-bar-red').style.width = score + '%'; });
        let currentTurn = 'X'; function makeMove(idx) { socket.emit('make move', { index: idx, symbol: currentTurn }); }
        socket.on('game update', state => { const cells = document.querySelectorAll('#ttt-grid .cell'); let xCount = 0; let oCount = 0; state.forEach((val, i) => { cells[i].innerText = val || ''; if (val === 'X') xCount++; if (val === 'O') oCount++; }); currentTurn = (xCount > oCount) ? 'O' : 'X'; });
        const canvas = document.getElementById('draw-board'); const ctx = canvas.getContext('2d'); ctx.lineWidth = 4; ctx.strokeStyle = '#ff4757'; let drawing = false; function getPos(e) { const rect = canvas.getBoundingClientRect(); return { x: (e.touches ? e.touches[0].clientX : e.clientX) - rect.left, y: (e.touches ? e.touches[0].clientY : e.clientY) - rect.top }; } function startDraw(e) { drawing = true; const pos = getPos(e); socket.emit('draw', { type: 'start', x: pos.x, y: pos.y }); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); } function drawLine(e) { if (!drawing) return; const pos = getPos(e); socket.emit('draw', { type: 'draw', x: pos.x, y: pos.y }); ctx.lineTo(pos.x, pos.y); ctx.stroke(); } function stopDraw() { drawing = false; } canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', drawLine); canvas.addEventListener('mouseup', stopDraw); canvas.addEventListener('touchstart', startDraw); canvas.addEventListener('touchmove', drawLine); canvas.addEventListener('touchend', stopDraw); socket.on('draw', data => { if (data.type === 'start') { ctx.beginPath(); ctx.moveTo(data.x, data.y); } else if (data.type === 'draw') { ctx.lineTo(data.x, data.y); ctx.stroke(); } else if (data.type === 'clear') { ctx.clearRect(0, 0, canvas.width, canvas.height); } }); function clearCanvas() { socket.emit('draw', { type: 'clear' }); ctx.clearRect(0, 0, canvas.width, canvas.height); }
    </script>
</body>
</html>
